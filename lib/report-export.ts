/**
 * æŠ¥å‘Šå¯¼å‡ºå·¥å…·åº“
 * æä¾›å¤åˆ¶åˆ°å‰ªè´´æ¿å’Œå¯¼å‡º PDF çš„åŠŸèƒ½
 */

interface Insight {
  title: string;
  severity: string;
  category: string;
  description: string;
  opportunity: string;
  quote: string | null;
  quoteAuthor?: string;
  quoteLink?: string;
}

interface AnalysisData {
  summary: string;
  frustrationScore: number;
  insights: Insight[];
}

interface ReportData {
  data: AnalysisData;
  query?: string;
  timestamp?: string;
}

/**
 * ç”Ÿæˆ JSON æ ¼å¼çš„æŠ¥å‘Šæ•°æ®
 */
export function generateReportJSON(reportData: ReportData): string {
  const { data, query, timestamp } = reportData;
  
  const report = {
    metadata: {
      title: 'Pain Point Analysis Report',
      query: query || 'N/A',
      generatedAt: timestamp || new Date().toISOString(),
      frustrationScore: data.frustrationScore,
    },
    summary: data.summary,
    insights: data.insights.map((insight, index) => ({
      rank: index + 1,
      title: insight.title,
      severity: insight.severity,
      category: insight.category,
      description: insight.description,
      opportunity: insight.opportunity,
      userFeedback: insight.quote ? {
        quote: insight.quote,
        author: insight.quoteAuthor || 'Reddit User',
        source: insight.quoteLink || null,
      } : null,
    })),
  };

  return JSON.stringify(report, null, 2);
}

/**
 * ç”Ÿæˆå¯è¯»çš„æ–‡æœ¬æ ¼å¼æŠ¥å‘Š
 */
export function generateReadableReport(reportData: ReportData): string {
  const { data, query, timestamp } = reportData;
  
  const lines = [
    'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
    'ğŸ” PAIN POINT ANALYSIS REPORT',
    'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
    '',
    'ğŸ“‹ REPORT DETAILS',
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    `Search Query: ${query || 'N/A'}`,
    `Generated: ${timestamp || new Date().toLocaleString()}`,
    `Frustration Score: ${data.frustrationScore}/100 ${getScoreEmoji(data.frustrationScore)}`,
    '',
    'ğŸ“Š EXECUTIVE SUMMARY',
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    data.summary,
    '',
    '',
    `ğŸ¯ TOP PAIN POINTS (${data.insights.length} identified)`,
    'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
    '',
  ];

  data.insights.forEach((insight, index) => {
    lines.push(`${index + 1}. ${insight.title}`);
    lines.push('â”€'.repeat(50));
    lines.push('');
    lines.push(`   ğŸ”¥ Severity: ${insight.severity}`);
    lines.push(`   ğŸ“ Category: ${insight.category}`);
    lines.push('');
    lines.push(`   ğŸ“ Description:`);
    lines.push(`   ${insight.description}`);
    lines.push('');
    lines.push(`   ğŸ’¡ Opportunity:`);
    lines.push(`   ${insight.opportunity}`);
    
    if (insight.quote) {
      lines.push('');
      lines.push(`   ğŸ’¬ User Quote:`);
      lines.push(`   "${insight.quote}"`);
      if (insight.quoteAuthor) {
        lines.push(`   â€” ${insight.quoteAuthor}`);
      }
      if (insight.quoteLink) {
        lines.push(`   ğŸ”— Source: ${insight.quoteLink}`);
      }
    }
    
    lines.push('');
    lines.push('');
  });

  lines.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  lines.push('Generated by AI Pain Point Analyzer');
  lines.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

  return lines.join('\n');
}

/**
 * æ ¹æ®åˆ†æ•°è¿”å›è¡¨æƒ…ç¬¦å·
 */
function getScoreEmoji(score: number): string {
  if (score >= 80) return 'ğŸ”´ Very High';
  if (score >= 60) return 'ğŸŸ  High';
  if (score >= 40) return 'ğŸŸ¡ Medium';
  return 'ğŸŸ¢ Low';
}

/**
 * å¤åˆ¶æŠ¥å‘Šåˆ°å‰ªè´´æ¿
 * @param reportData æŠ¥å‘Šæ•°æ®
 * @param format æ ¼å¼ï¼š'readable'ï¼ˆå¯è¯»æ–‡æœ¬ï¼‰æˆ– 'json'
 * @returns Promise<boolean> æ˜¯å¦æˆåŠŸ
 */
export async function copyReportToClipboard(
  reportData: ReportData,
  format: 'readable' | 'json' = 'readable'
): Promise<boolean> {
  try {
    const content = format === 'json' 
      ? generateReportJSON(reportData)
      : generateReadableReport(reportData);

    await navigator.clipboard.writeText(content);
    return true;
  } catch (error) {
    console.error('[ReportExport] Failed to copy to clipboard:', error);
    return false;
  }
}

/**
 * å¯¼å‡ºæŠ¥å‘Šä¸º PDFï¼ˆç›´æ¥ä¸‹è½½ï¼‰
 * æ­¥éª¤ï¼š
 * 1. ç‚¹å‡» "Export to PDF"
 * 2. ç›´æ¥æ‰“å¼€æ–‡ä»¶ä¿å­˜å¯¹è¯æ¡†
 * 3. ç”¨æˆ·é€‰æ‹©å­˜æ”¾ç›®å½•åœ°å€
 * 4. ç”¨æˆ·ç‚¹å‡»"ä¿å­˜"æŒ‰é’®
 * 5. PDF æ–‡ä»¶ä¸‹è½½å®Œæˆï¼
 */
export async function exportReportToPDF(reportData: ReportData): Promise<void> {
  const { data, query } = reportData;
  
  // åŠ¨æ€å¯¼å…¥ jsPDF å’Œ html2canvas
  const { default: jsPDF } = await import('jspdf');
  const html2canvas = (await import('html2canvas')).default;
  
  // ç”Ÿæˆæ–‡ä»¶å
  const filename = `pain-point-report-${query?.replace(/\s+/g, '-').toLowerCase() || 'analysis'}.pdf`;
  
  // åˆ›å»ºä¸´æ—¶å®¹å™¨
  const container = document.createElement('div');
  container.style.position = 'fixed';
  container.style.left = '-9999px';
  container.style.top = '0';
  container.style.width = '210mm'; // A4 å®½åº¦
  container.style.padding = '20mm';
  container.style.backgroundColor = 'white';
  container.innerHTML = generatePrintableHTML(reportData);
  document.body.appendChild(container);
  
  try {
    // å°† HTML è½¬æ¢ä¸º Canvas
    const canvas = await html2canvas(container, {
      scale: 2, // æé«˜æ¸…æ™°åº¦
      useCORS: true,
      logging: false,
      backgroundColor: '#ffffff',
    });
    
    // åˆ›å»º PDF
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4',
    });
    
    const imgWidth = 210; // A4 å®½åº¦ï¼ˆmmï¼‰
    const pageHeight = 297; // A4 é«˜åº¦ï¼ˆmmï¼‰
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;
    
    const imgData = canvas.toDataURL('image/png');
    
    // æ·»åŠ ç¬¬ä¸€é¡µ
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;
    
    // å¦‚æœå†…å®¹è¶…è¿‡ä¸€é¡µï¼Œæ·»åŠ æ›´å¤šé¡µé¢
    while (heightLeft > 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }
    
    // è§¦å‘ä¸‹è½½ - ç›´æ¥å¼¹å‡ºä¿å­˜å¯¹è¯æ¡†
    pdf.save(filename);
    
  } finally {
    // æ¸…ç†ä¸´æ—¶å®¹å™¨
    document.body.removeChild(container);
  }
}

/**
 * ç”Ÿæˆå¯æ‰“å°çš„ HTMLï¼ˆç”¨äº PDF ç”Ÿæˆï¼‰
 */
function generatePrintableHTML(reportData: ReportData): string {
  const { data, query, timestamp } = reportData;
  
  return `
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    line-height: 1.6;
    color: #1f2937;
    font-size: 11pt;
    background: white;
    padding: 20px;
  }
  
  .header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 3px solid #3b82f6;
  }
  
  h1 {
    font-size: 28pt;
    font-weight: bold;
    margin-bottom: 10px;
    color: #111827;
  }
  
  .subtitle {
    font-size: 12pt;
    color: #6b7280;
    margin-top: 5px;
  }
  
  .metadata {
    background: #f3f4f6;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 25px;
    font-size: 10pt;
  }
  
  .metadata-row {
    display: flex;
    justify-content: space-between;
    margin: 5px 0;
    align-items: center;
  }
  
  .metadata-label {
    font-weight: 600;
    color: #6b7280;
  }
  
  .score-badge {
    display: inline-block;
    background: #fef2f2;
    color: #dc2626;
    padding: 8px 20px;
    border-radius: 25px;
    font-weight: 700;
    font-size: 16pt;
    border: 2px solid #fecaca;
  }
  
  h2 {
    font-size: 18pt;
    font-weight: 600;
    margin-top: 30px;
    margin-bottom: 15px;
    color: #111827;
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 10px;
  }
  
  .summary {
    background: #f9fafb;
    padding: 18px;
    border-radius: 8px;
    margin-bottom: 30px;
    border-left: 5px solid #3b82f6;
    font-size: 11pt;
    line-height: 1.8;
  }
  
  .insights-count {
    color: #6b7280;
    font-size: 12pt;
    margin-bottom: 20px;
    font-weight: 500;
  }
  
  .insight-card {
    background: #ffffff;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
  }
  
  .insight-header {
    margin-bottom: 15px;
  }
  
  .insight-title {
    font-size: 14pt;
    font-weight: 700;
    color: #111827;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .insight-rank {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    min-width: 32px;
    height: 32px;
    border-radius: 50%;
    font-weight: bold;
    font-size: 12pt;
    flex-shrink: 0;
  }
  
  .badges {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  
  .badge {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 9pt;
    font-weight: 600;
    border: 1px solid;
  }
  
  .badge-high {
    background: #fee2e2;
    color: #991b1b;
    border-color: #fecaca;
  }
  
  .badge-medium {
    background: #fed7aa;
    color: #9a3412;
    border-color: #fdba74;
  }
  
  .badge-low {
    background: #fef3c7;
    color: #92400e;
    border-color: #fde68a;
  }
  
  .badge-category {
    background: #dbeafe;
    color: #1e40af;
    border-color: #bfdbfe;
  }
  
  .section {
    margin-bottom: 15px;
  }
  
  .section-label {
    font-weight: 700;
    color: #374151;
    font-size: 10pt;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .description {
    color: #4b5563;
    font-size: 10.5pt;
    line-height: 1.7;
  }
  
  .opportunity-box {
    background: linear-gradient(135deg, #ecfeff 0%, #dbeafe 100%);
    border: 2px solid #67e8f9;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
  }
  
  .opportunity-label {
    font-weight: 700;
    color: #0e7490;
    font-size: 10pt;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .opportunity-text {
    color: #164e63;
    font-size: 10.5pt;
    line-height: 1.7;
  }
  
  .quote-box {
    border-left: 4px solid #d1d5db;
    background: #f9fafb;
    padding: 12px 15px;
    margin-top: 15px;
    border-radius: 4px;
  }
  
  .quote-text {
    font-style: italic;
    color: #6b7280;
    font-size: 10pt;
    line-height: 1.6;
    margin-bottom: 8px;
  }
  
  .quote-author {
    font-size: 9pt;
    font-style: normal;
    font-weight: 600;
    color: #9ca3af;
  }
  
  .footer {
    margin-top: 40px;
    padding-top: 20px;
    border-top: 2px solid #e5e7eb;
    text-align: center;
    font-size: 9pt;
    color: #9ca3af;
  }
  
  .footer-logo {
    font-weight: 700;
    color: #3b82f6;
    font-size: 10pt;
    margin-bottom: 5px;
  }
</style>

<div class="container">
  <div class="header">
    <h1>ğŸ” Pain Point Analysis Report</h1>
    <div class="subtitle">Comprehensive User Pain Point Discovery & Analysis</div>
  </div>
  
  <div class="metadata">
    <div class="metadata-row">
      <span><span class="metadata-label">Search Query:</span> ${query || 'N/A'}</span>
      <span><span class="metadata-label">Generated:</span> ${timestamp || new Date().toLocaleString()}</span>
    </div>
    <div class="metadata-row" style="margin-top: 12px;">
      <span class="metadata-label">Frustration Score:</span>
      <span class="score-badge">${data.frustrationScore} / 100</span>
    </div>
  </div>
  
  <h2>ğŸ“Š Executive Summary</h2>
  <div class="summary">
    ${data.summary}
  </div>
  
  <h2>ğŸ¯ Detailed Pain Point Analysis</h2>
  <div class="insights-count">Total Pain Points Identified: <strong>${data.insights.length}</strong></div>
  
  ${data.insights.map((insight, index) => `
    <div class="insight-card">
      <div class="insight-header">
        <div class="insight-title">
          <span class="insight-rank">${index + 1}</span>
          <span>${insight.title}</span>
        </div>
        
        <div class="badges">
          <span class="badge ${getSeverityClass(insight.severity)}">ğŸ”¥ ${insight.severity}</span>
          <span class="badge badge-category">ğŸ“ ${insight.category}</span>
        </div>
      </div>
      
      <div class="section">
        <div class="section-label">Problem Description</div>
        <div class="description">${insight.description}</div>
      </div>
      
      <div class="opportunity-box">
        <div class="opportunity-label">ğŸ’¡ Business Opportunity</div>
        <div class="opportunity-text">${insight.opportunity}</div>
      </div>
      
      ${insight.quote ? `
        <div class="quote-box">
          <div class="quote-text">"${insight.quote}"</div>
          <div class="quote-author">â€” ${insight.quoteAuthor || 'Anonymous User'}</div>
        </div>
      ` : ''}
    </div>
  `).join('')}
  
  <div class="footer">
    <div class="footer-logo">AI Pain Point Analyzer</div>
    <div>Â© ${new Date().getFullYear()} All Rights Reserved</div>
    <div style="margin-top: 5px; font-size: 8pt; color: #d1d5db;">
      This report is generated automatically using AI analysis
    </div>
  </div>
</div>
  `;
}

/**
 * è¾…åŠ©å‡½æ•°ï¼šè·å–ä¸¥é‡æ€§å¯¹åº”çš„ CSS ç±»
 */
function getSeverityClass(severity: string): string {
  if (severity.toLowerCase().includes('high') || severity.includes('é«˜')) {
    return 'badge-high';
  }
  if (severity.toLowerCase().includes('medium') || severity.includes('ä¸­')) {
    return 'badge-medium';
  }
  return 'badge-low';
}
